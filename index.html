
<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>‡∏ö‡πâ‡∏≤‡∏ô‡∏´‡∏≠‡∏°‡∏ä‡∏≤‡∏û‡∏∞‡πÄ‡∏¢‡∏≤ - Smart Queue (Python)</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@stlite/mountable@0.58.1/build/stlite.css" />
</head>
<body>
    <div id="root"></div>
    <script src="https://cdn.jsdelivr.net/npm/@stlite/mountable@0.58.1/build/stlite.js"></script>
    <script>
        stlite.mount({
            requirements: ["google-generativeai", "pandas"],
            entrypoint: "app.py",
            historyType: "hash", // CRITICAL: Fixes pushState error in sandboxed environments
            files: {
                "app.py": `
import streamlit as st
import google.generativeai as genai
import os
import time
from datetime import datetime

# --- CONFIGURATION ---
st.set_page_config(page_title="‡∏ö‡πâ‡∏≤‡∏ô‡∏´‡∏≠‡∏°‡∏ä‡∏≤‡∏û‡∏∞‡πÄ‡∏¢‡∏≤ - Smart Queue", layout="wide", page_icon="üçµ")

# Custom CSS for Emerald Theme
st.markdown("""
    <style>
    @import url('https://fonts.googleapis.com/css2?family=Anuphan:wght@100;400;700&display=swap');
    
    html, body, [class*="css"] {
        font-family: 'Anuphan', sans-serif;
        background-color: #f0fdf4;
    }
    
    .stApp {
        background-color: #f0fdf4;
    }

    .main-title {
        color: #064e3b;
        font-weight: 900;
        font-size: 2.5rem;
        letter-spacing: -1.5px;
        margin-bottom: 10px;
    }

    .card {
        background: white;
        padding: 20px;
        border-radius: 25px;
        box-shadow: 0 10px 20px rgba(6, 78, 59, 0.04);
        border: 1px solid #ecfdf5;
        margin-bottom: 15px;
        transition: transform 0.2s;
    }
    
    .card:hover {
        transform: translateY(-3px);
    }

    .price-tag {
        background-color: #065f46;
        color: white;
        padding: 4px 12px;
        border-radius: 10px;
        font-weight: bold;
    }

    .queue-number {
        font-size: 3.5rem;
        font-weight: 900;
        color: #059669;
        text-align: center;
        line-height: 1;
    }

    .status-badge {
        padding: 2px 8px;
        border-radius: 8px;
        font-size: 0.8rem;
        font-weight: bold;
    }
    </style>
""", unsafe_allow_html=True)

# --- SESSION STATE INITIALIZATION ---
if 'menu' not in st.session_state:
    st.session_state.menu = [
        {"id": "d1", "name": "‡∏ä‡∏≤‡πÑ‡∏ó‡∏¢‡πÄ‡∏¢‡πá‡∏ô ‡∏™‡∏π‡∏ï‡∏£‡∏û‡∏∞‡πÄ‡∏¢‡∏≤", "price": 45, "cat": "drink", "desc": "‡∏´‡∏≠‡∏°‡πÄ‡∏Ç‡πâ‡∏°‡∏Ç‡πâ‡∏ô ‡∏´‡∏ß‡∏≤‡∏ô‡∏°‡∏±‡∏ô‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏î‡∏µ"},
        {"id": "f2", "name": "‡∏Å‡πã‡∏ß‡∏¢‡πÄ‡∏ï‡∏µ‡πã‡∏¢‡∏ß‡πÄ‡∏£‡∏∑‡∏≠‡πÄ‡∏ô‡∏∑‡πâ‡∏≠‡∏ß‡∏≤‡∏Å‡∏¥‡∏ß", "price": 120, "cat": "food", "desc": "‡∏ô‡πâ‡∏≥‡∏ï‡∏Å‡πÄ‡∏Ç‡πâ‡∏°‡∏Ç‡πâ‡∏ô ‡πÄ‡∏ô‡∏∑‡πâ‡∏≠‡∏ß‡∏≤‡∏Å‡∏¥‡∏ß‡∏û‡∏£‡∏µ‡πÄ‡∏°‡∏µ‡∏¢‡∏°"},
        {"id": "f3", "name": "‡∏ô‡πâ‡∏≥‡∏û‡∏£‡∏¥‡∏Å‡∏´‡∏ô‡∏∏‡πà‡∏° ‡∏ú‡∏±‡∏Å‡∏•‡∏ß‡∏Å", "price": 65, "cat": "food", "desc": "‡∏™‡∏π‡∏ï‡∏£‡πÄ‡∏°‡∏∑‡∏≠‡∏á‡∏û‡∏∞‡πÄ‡∏¢‡∏≤‡πÅ‡∏ó‡πâ"},
        {"id": "d2", "name": "‡∏≠‡∏±‡∏ç‡∏ä‡∏±‡∏ô‡∏°‡∏∞‡∏ô‡∏≤‡∏ß‡∏ô‡πâ‡∏≥‡∏ú‡∏∂‡πâ‡∏á", "price": 40, "cat": "drink", "desc": "‡∏ô‡πâ‡∏≥‡∏ú‡∏∂‡πâ‡∏á‡πÅ‡∏ó‡πâ‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡∏´‡πâ‡∏≤"}
    ]

if 'orders' not in st.session_state:
    st.session_state.orders = []

if 'cart' not in st.session_state:
    st.session_state.cart = []

if 'next_q' not in st.session_state:
    st.session_state.next_q = 1

if 'ai_history' not in st.session_state:
    st.session_state.ai_history = []

# --- GEMINI AI INTEGRATION ---
def get_ai_response(prompt):
    api_key = os.environ.get("API_KEY", "")
    if not api_key:
        return "‡∏Ç‡∏≠‡∏≠‡∏†‡∏±‡∏¢‡∏Ñ‡∏£‡∏±‡∏ö ‡πÑ‡∏°‡πà‡∏û‡∏ö API KEY ‡πÉ‡∏ô‡∏£‡∏∞‡∏ö‡∏ö ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏Å‡∏≤‡∏£‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤"
    
    try:
        genai.configure(api_key=api_key)
        model = genai.GenerativeModel('gemini-3-flash-preview')
        context = f"‡∏Ñ‡∏∏‡∏ì‡∏Ñ‡∏∑‡∏≠‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô‡∏£‡πâ‡∏≤‡∏ô ‡∏ö‡πâ‡∏≤‡∏ô‡∏´‡∏≠‡∏°‡∏ä‡∏≤‡∏û‡∏∞‡πÄ‡∏¢‡∏≤ ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÄ‡∏°‡∏ô‡∏π: {st.session_state.menu}. ‡∏ï‡∏≠‡∏ö‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏°‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏™‡∏∏‡∏†‡∏≤‡∏û"
        response = model.generate_content(f"{context}\\n‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤‡∏ñ‡∏≤‡∏°‡∏ß‡πà‡∏≤: {prompt}")
        return response.text
    except Exception as e:
        return f"‡∏Ç‡∏≠‡∏≠‡∏†‡∏±‡∏¢‡∏Ñ‡∏£‡∏±‡∏ö ‡∏£‡∏∞‡∏ö‡∏ö AI ‡∏Ç‡∏±‡∏î‡∏Ç‡πâ‡∏≠‡∏á: {str(e)}"

# --- SIDEBAR NAVIGATION ---
with st.sidebar:
    st.markdown("<h2 style='color:#064e3b;'>üçµ ‡∏ö‡πâ‡∏≤‡∏ô‡∏´‡∏≠‡∏°‡∏ä‡∏≤</h2>", unsafe_allow_html=True)
    mode = st.radio("‡πÄ‡∏°‡∏ô‡∏π‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô", ["üõí ‡∏™‡∏±‡πà‡∏á‡∏≠‡∏≤‡∏´‡∏≤‡∏£", "üìã ‡πÄ‡∏ä‡πá‡∏Ñ‡∏Ñ‡∏¥‡∏ß", "ü§ñ ‡∏ñ‡∏≤‡∏° AI", "‚öôÔ∏è ‡∏´‡∏•‡∏±‡∏á‡∏£‡πâ‡∏≤‡∏ô"])
    
    if mode == "‚öôÔ∏è ‡∏´‡∏•‡∏±‡∏á‡∏£‡πâ‡∏≤‡∏ô":
        pwd = st.text_input("‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô", type="password")
        if pwd != "907264":
            st.warning("‡πÉ‡∏™‡πà‡∏£‡∏´‡∏±‡∏™ 907264 ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏Ç‡πâ‡∏≤‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡πÇ‡∏´‡∏°‡∏î‡∏´‡∏•‡∏±‡∏á‡∏£‡πâ‡∏≤‡∏ô")
            mode = "üõí ‡∏™‡∏±‡πà‡∏á‡∏≠‡∏≤‡∏´‡∏≤‡∏£" # Fallback if not authorized

    st.divider()
    if st.button("üîÑ ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô‡πÉ‡∏´‡∏°‡πà (Reset)"):
        st.session_state.orders = []
        st.session_state.next_q = 1
        st.session_state.cart = []
        st.rerun()

# --- MAIN LOGIC ---
if mode == "üõí ‡∏™‡∏±‡πà‡∏á‡∏≠‡∏≤‡∏´‡∏≤‡∏£":
    st.markdown("<h1 class='main-title'>‡∏ö‡πâ‡∏≤‡∏ô‡∏´‡∏≠‡∏°‡∏ä‡∏≤‡∏û‡∏∞‡πÄ‡∏¢‡∏≤</h1>", unsafe_allow_html=True)
    c_m, c_c = st.columns([2, 1])
    
    with c_m:
        st.subheader("üìã ‡πÄ‡∏°‡∏ô‡∏π‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥")
        cols = st.columns(2)
        for i, it in enumerate(st.session_state.menu):
            with cols[i%2]:
                st.markdown(f"<div class='card'><h4>{it['name']}</h4><p style='color:gray; font-size:0.8rem;'>{it['desc']}</p><span class='price-tag'>‡∏ø{it['price']}</span></div>", unsafe_allow_html=True)
                if st.button(f"‡πÄ‡∏•‡∏∑‡∏≠‡∏Å {it['name']}", key=f"b_{it['id']}"):
                    st.session_state.cart.append(it)
                    st.toast(f"‡πÄ‡∏û‡∏¥‡πà‡∏° {it['name']} ‡πÅ‡∏•‡πâ‡∏ß")
    
    with c_c:
        st.subheader("üß∫ ‡∏ï‡∏∞‡∏Å‡∏£‡πâ‡∏≤‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì")
        if not st.session_state.cart:
            st.info("‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÉ‡∏ô‡∏ï‡∏∞‡∏Å‡∏£‡πâ‡∏≤")
        else:
            total = sum(i['price'] for i in st.session_state.cart)
            for idx, i in enumerate(st.session_state.cart):
                col_i, col_d = st.columns([4, 1])
                col_i.write(f"{i['name']} - {i['price']}.-")
                if col_d.button("üóëÔ∏è", key=f"del_{idx}"):
                    st.session_state.cart.pop(idx)
                    st.rerun()
            st.markdown(f"### ‡∏£‡∏ß‡∏°‡∏ó‡∏±‡πâ‡∏á‡∏™‡∏¥‡πâ‡∏ô: ‡∏ø{total}")
            name = st.text_input("‡∏ä‡∏∑‡πà‡∏≠‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤ (‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÄ‡∏£‡∏µ‡∏¢‡∏Å‡∏Ñ‡∏¥‡∏ß)")
            if st.button("üöÄ ‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏™‡∏±‡πà‡∏á‡∏ã‡∏∑‡πâ‡∏≠"):
                if name and st.session_state.cart:
                    q = f"A{str(st.session_state.next_q).zfill(3)}"
                    st.session_state.orders.append({
                        "id": time.time(),
                        "q": q,
                        "name": name,
                        "items": st.session_state.cart.copy(),
                        "total": total,
                        "status": "PENDING",
                        "time": datetime.now().strftime("%H:%M")
                    })
                    st.session_state.next_q += 1
                    st.session_state.cart = []
                    st.success(f"‡∏™‡∏±‡πà‡∏á‡∏ã‡∏∑‡πâ‡∏≠‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à! ‡∏Ñ‡∏¥‡∏ß‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì‡∏Ñ‡∏∑‡∏≠ {q}")
                    time.sleep(1)
                    st.rerun()
                else:
                    st.error("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏£‡∏∞‡∏ö‡∏∏‡∏ä‡∏∑‡πà‡∏≠‡πÅ‡∏•‡∏∞‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏≠‡∏≤‡∏´‡∏≤‡∏£")

elif mode == "üìã ‡πÄ‡∏ä‡πá‡∏Ñ‡∏Ñ‡∏¥‡∏ß":
    st.markdown("<h1 class='main-title'>‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏Ñ‡∏¥‡∏ß</h1>", unsafe_allow_html=True)
    ready = [o for o in st.session_state.orders if o['status'] == "READY"]
    prep = [o for o in st.session_state.orders if o['status'] in ["PENDING", "PREPARING"]]
    cancelled = [o for o in st.session_state.orders if o['status'] == "CANCEL"]
    
    c1, c2 = st.columns(2)
    with c1:
        st.success("‚úÖ ‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏£‡∏±‡∏ö (Ready)")
        if not ready: st.write("-")
        for o in ready: 
            st.markdown(f"<div class='card'><div class='queue-number'>{o['q']}</div><p style='text-align:center;'>‡∏Ñ‡∏∏‡∏ì {o['name']}</p></div>", unsafe_allow_html=True)
            
    with c2:
        st.info("‚è≥ ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÄ‡∏ï‡∏£‡∏µ‡∏¢‡∏° (Preparing)")
        if not prep: st.write("-")
        for o in prep: 
            st.markdown(f"<div class='card' style='text-align:center;'><h3>{o['q']}</h3><small>‡∏Ñ‡∏∏‡∏ì {o['name']}</small></div>", unsafe_allow_html=True)
    
    if cancelled:
        st.divider()
        st.error("‚ùå ‡∏≠‡∏≠‡∏£‡πå‡πÄ‡∏î‡∏≠‡∏£‡πå‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Ç‡∏≠‡∏≠‡∏†‡∏±‡∏¢ (Cancelled)")
        for o in cancelled:
            st.warning(f"‡∏Ñ‡∏¥‡∏ß {o['q']} (‡∏Ñ‡∏∏‡∏ì {o['name']}): ‡∏ó‡∏≤‡∏á‡∏£‡πâ‡∏≤‡∏ô‡∏ï‡πâ‡∏≠‡∏á‡∏Ç‡∏≠‡∏≠‡∏†‡∏±‡∏¢‡∏ó‡∏µ‡πà‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏£‡∏±‡∏ö‡∏≠‡∏≠‡∏£‡πå‡πÄ‡∏î‡∏≠‡∏£‡πå‡πÑ‡∏î‡πâ‡πÉ‡∏ô‡∏Ç‡∏ì‡∏∞‡∏ô‡∏µ‡πâ")

elif mode == "ü§ñ ‡∏ñ‡∏≤‡∏° AI":
    st.markdown("<h1 class='main-title'>‡∏ú‡∏π‡πâ‡∏ä‡πà‡∏ß‡∏¢ AI ‡∏≠‡∏±‡∏à‡∏â‡∏£‡∏¥‡∏¢‡∏∞</h1>", unsafe_allow_html=True)
    for m in st.session_state.ai_history:
        with st.chat_message("user" if m["r"]=="user" else "assistant"):
            st.write(m["c"])
            
    if q := st.chat_input("‡∏™‡∏≠‡∏ö‡∏ñ‡∏≤‡∏°‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏£‡πâ‡∏≤‡∏ô‡∏´‡∏£‡∏∑‡∏≠‡πÄ‡∏°‡∏ô‡∏π..."):
        st.session_state.ai_history.append({"r":"user","c":q})
        with st.chat_message("user"): st.write(q)
        with st.chat_message("assistant"):
            with st.spinner("‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏Ñ‡∏¥‡∏î..."):
                response = get_ai_response(q)
                st.write(response)
                st.session_state.ai_history.append({"r":"ai","c":response})

elif mode == "‚öôÔ∏è ‡∏´‡∏•‡∏±‡∏á‡∏£‡πâ‡∏≤‡∏ô":
    st.markdown("<h1 class='main-title'>‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏≠‡∏≠‡∏£‡πå‡πÄ‡∏î‡∏≠‡∏£‡πå</h1>", unsafe_allow_html=True)
    active = [o for o in st.session_state.orders if o['status'] not in ["DONE", "CANCEL"]]
    
    if not active:
        st.info("‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏≠‡∏≠‡∏£‡πå‡πÄ‡∏î‡∏≠‡∏£‡πå‡πÉ‡∏´‡∏°‡πà")
    
    for o in active:
        with st.container():
            st.markdown(f"<div class='card'><b>{o['q']} - ‡∏Ñ‡∏∏‡∏ì {o['name']}</b> (‡∏ø{o['total']}) <br/><small>{o['time']}</small></div>", unsafe_allow_html=True)
            cc = st.columns(4)
            if o['status'] == "PENDING" and cc[0].button("‡∏£‡∏±‡∏ö‡∏≠‡∏≠‡∏£‡πå‡πÄ‡∏î‡∏≠‡∏£‡πå", key=f"ac_{o['q']}"): 
                o['status']="PREPARING"
                st.rerun()
            if o['status'] == "PREPARING" and cc[0].button("‡πÅ‡∏à‡πâ‡∏á‡∏û‡∏£‡πâ‡∏≠‡∏°‡πÄ‡∏™‡∏¥‡∏£‡πå‡∏ü", key=f"rd_{o['q']}"): 
                o['status']="READY"
                st.rerun()
            if o['status'] == "READY" and cc[0].button("‡∏™‡πà‡∏á‡∏°‡∏≠‡∏ö‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢", key=f"dn_{o['q']}"): 
                o['status']="DONE"
                st.rerun()
            if cc[1].button("‚ùå ‡∏õ‡∏è‡∏¥‡πÄ‡∏™‡∏ò/‡∏Ç‡∏≠‡∏≠‡∏†‡∏±‡∏¢", key=f"cl_{o['q']}"): 
                o['status']="CANCEL"
                st.rerun()
`
            },
            env: {
                API_KEY: "process.env.API_KEY"
            }
        }, document.getElementById("root"))
    </script>
</body>
</html>
